<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
  </head>
  <body>
      <h1>Configure templates</h1>
      <div class="form-body">
        <h3>Set template options</h3>
        <form id="template-options-form">
          <label for="use-template-select">Use template based on:</label>
          <select name="use-template-select" id="use-template-select">
            <option value="selected-column-value">Column value</option>
            <option value="selected-default-template">Default template</option>
          </select>
          <label for="select-column-headers">Column values:</label>
          <select name="select-column-headers" id="select-column-headers">
             <option>Loading options....</option>
          </select>
        </form>
      </div>
    </div>

    <script>
      // Helper function to run server-side scripts asyncronously.
      function createAsyncScriptRunner(successHandler, failureHandler=((error) => alert(`ERROR: ${error.message}`))) {
        let scriptRunner = google.script.run.withFailureHandler(failureHandler);
        return scriptRunner.withSuccessHandler(successHandler);
      }

      // Text boxes to select templates used for different options.
      function createColumnValueForm(columnValues) {
        console.log(`LOGGING ${columnValues}`);
        // If menu has already been created, re-populate the existing menu instead of creating a new one.
        if (document.querySelector("#map-column-values") != null) {
          const mapColumnVals = document.querySelector("#map-column-values");
          mapColumnVals.innerHTML = "";
          // Add a new option for each column value.
          for (let i = 0; i < columnValues.length; i++) {
            let textBox = document.createElement('input');
            textBox.id = `template-text-box-${columnValues[i]}`;
            textBox.type = "text";
            textBox.placeholder = "Enter template name here";
            const textBoxLabel = document.createElement("label");
            textBoxLabel.setAttribute("for", `template-text-box-${columnValues[i]}`);
            textBoxLabel.innerHTML = `If value is ${columnValues[i]} use template: `;
            mapColumnVals.appendChild(textBoxLabel);
            mapColumnVals.appendChild(textBox);
          }
          return;
        }
        // Otherwise, create a new select menu.
        const templateOptionsForm = document.querySelector("#template-options-form");
        const mapColumnValues = document.createElement('div');
        mapColumnValues.id = "map-column-values";

        // Add a new option for each column value.
        for (let i = 0; i < columnValues.length; i++) {
            let textBox = document.createElement('input');
            textBox.id = `template-text-box-${columnValues[i]}`;
            textBox.type = "text";
            textBox.placeholder = "Enter template name here";
            const textBoxLabel = document.createElement("label");
            textBoxLabel.setAttribute("for", `template-text-box-${columnValues[i]}`);
            textBoxLabel.innerHTML = `If value is ${columnValues[i]} use template: `;
            mapColumnValues.appendChild(textBoxLabel);
            mapColumnValues.appendChild(textBox);
        }
        templateOptionsForm.appendChild(mapColumnValues);
      }

      // Populate the column header select menu with column header options.
      function populateColumnHeaderSelectMenu(columnHeaders) {
        const columnHeaderSelect = document.querySelector('#select-column-headers');
        columnHeaderSelect.innerHTML = ""; // Clear the 'loading' text.
        // Add a new option for each column header.
        for (let i = 0; i < columnHeaders.length; i++) {
          let opt = document.createElement('option');
          opt.value = columnHeaders[i];
          opt.innerHTML = columnHeaders[i];
          columnHeaderSelect.appendChild(opt);
        }

        columnHeaderSelect.addEventListener("change", () => {
          const selectedColumn = columnHeaderSelect.value;
          createAsyncScriptRunner(createColumnValueForm).getColumnValuesByName(selectedColumn);
        });
      }

      // Async creation of column name options.
      createAsyncScriptRunner(populateColumnHeaderSelectMenu).getColumnNames();

    </script>
  </body>
</html>
